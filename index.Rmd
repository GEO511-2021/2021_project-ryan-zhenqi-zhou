---
title: "Detecting the pedestrian shed and walking route environment of urban parks with open-source data"
author: Ryan Zhenqi Zhou
subtitle: A Case Study in Xuanwu Lake Park, China
output:
  html_document:
    code_folding: show
    number_sections: true
---

# Introduction 

Visiting parks provides considerable health benefits, including supporting physical activity, reducing the risk of obesity, and improving the life expectancy of citizens (Blanck, et al., 2012; Takano, et al., 2002). Whether people walk to a park is usually affected by the park’s attractiveness and their walking experience (Rigolon et al., 2018). The latter is associated with the walking distance to the park and relevant urban design features along
the route, which have received insufficient attention, compared to the facilities and environments within parks. Environmental factors have been found to influence people’s walking choices around parks (Owen et al., 2004). For example, routes to the park that cover long distances, potential traffic injury risks, and poor pedestrian environments could be substantial barriers for park visitors. Furthermore, the walkability of streets near parks has been particularly correlated to pedestrian perceptions of safety. Therefore, analysis of walking routes to parks provides a promising approach to understand the physical environment around parks, which may facilitate predicting public health benefits for people and environmental benefits for cities.

With Xuanwu Lake Park as a case study, I use the walking routes recommended by online map services to depict two basic aspects of walkable routes to the park: distance from home to park and pedestrian environment along the route. The objective measurements are synthesized to delineate the pedestrian shed rapidly and audit the walking route environment objectively. 

# Materials and methods
## Import packages
```{r, message=F, warning=F}
library(sf)
library(tidyverse)
library(tmap)
library(leaflet)
library(DT)
```

## Data import and demostration
I collected data from my own previous research projects. Most of them are from Baidu Map API.

* Residential building points of interest around Xuanwu Lake Park (Point)
* Xuanwu Lake Park entrances (Point)
* Walking routes (Line): According to the policy of the 15-Minute Community-Life Circle, a 15-min walk to parks is important for residents in China, which corresponds to about a 1000-m distance (Shanghai Administration Bureau, 2016). I called the travel navigation function of Baidu Map to scrape recommended walking routes from residential buildings to the entrances of Xuanwu Lake Park, with a 15-min duration as the threshold. This data also includes the information of route distance, euclidean distance, duration, the number of turns, the number of crossings, starting, and ending points.
* Community Boundaries around Xuanwu Lake Park (Polygon)

### Walking route data
```{r, message=F, warning=F}
walkroutes <- read_csv("data/Walking routes.csv")
walkroutes_ta <- subset(walkroutes, select=-c(geometry))
DT::datatable(walkroutes_ta %>% head(30),
              options = list(pageLength = 5), 
              caption = "Table 1: Samples of the walking route data.")
```

### Upload and spatialize data
```{r, message=F, warning=F}
walkroutes_sf <- st_as_sf(walkroutes, wkt = "geometry",  crs=4326)
ori_points <- st_as_sf(walkroutes_ta, coords = c("ori_lng_84","ori_lat_84"),  crs=4326)
des_points <- st_as_sf(walkroutes_ta, coords = c("des_lng_84","des_lat_84"),  crs=4326)
boundary <- read_sf("data/Park Boundary.shp")
boundary_li = st_cast(boundary, "LINESTRING")
AOIs <- read_sf("data/Community boundary.shp")
```

Show the whole data set
```{r, fig.align = "center", message=F, warning=F}
current.mode <- tmap_mode("view")
bound_box <- c(left = 118.7772332, bottom = 32.0550625, right = 118.8104844, top = 32.0902245)
map_1 <- tm_basemap(leaflet::providers$Esri.WorldTopoMap, alpha = 0.4) +
  tm_shape(AOIs) + 
  tm_polygons(size = 0.06, col = "azure3", border.alpha = 0) +
  tm_shape(boundary_li, bbox = bound_box) +
  tm_lines(scale = 4, col = "red") + 
  tm_shape(walkroutes_sf) +
  tm_lines(scale = 0.5, col = "blue") +
  tm_shape(ori_points) +
  tm_symbols(size = 0.1, col = "goldenrod1") +
  tm_shape(des_points) +
  tm_symbols(size = 0.06, col = "chartreuse", border.alpha = 0) 
   
map_1
```

Noted that the orange points are park entrances, green points are residential building POIs, blue lines are walking routes, red line are park boundary, grey polygons are community boundaries.

A reasonable walking distance is necessary for daily park users. There are many measurement to define pedestrian shed.

Euclidean distance buffer method and service areas
```{r, fig.align = "center", message=F, warning=F}
boundary_li_pro <- st_transform(boundary_li, "EPSG:32650")
boundary_pro <- st_transform(boundary, "EPSG:32650")
boundary_bu <- st_buffer(boundary_li_pro, 1000)
boundary_di <- st_difference(boundary_bu, boundary_pro)
area_ED <- st_area(boundary_di)

background_bu <- read_sf("data/Background buildings.shp")
background_ro <- read_sf("data/Background routes.shp")

current.mode <- tmap_mode("plot")
boundary_di_bu <- st_buffer(boundary_di, 500)
map_2 <- tm_shape(background_bu, bbox = boundary_di_bu) +
  tm_polygons(col = "azure2", border.alpha = 0) + 
  tm_shape(background_ro) +
  tm_lines(scale = 0.5, col = "azure2") +
  tm_shape(boundary_di) +
  tm_polygons(scale = 4, col = "deepskyblue3", alpha = 0.5, border.alpha = 0) + 
  tm_shape(boundary_li) +
  tm_lines(scale = 4, col = "red") +
  tm_credits(expression("Service areas with Euclidean distance buffer method is"~13~"km"^2), position=c("left", "bottom"))

map_2
```
line-based network 50m-buffer method and service areas
```{r, fig.align = "center", message=F, warning=F}
walkroutes_pro <- st_transform(walkroutes_sf, "EPSG:32650")
walkroutes_pro_un <- st_union(walkroutes_pro)
walkroutes_bu <- st_buffer(walkroutes_pro_un, 50)
walkroutes_di <- st_difference(walkroutes_bu, boundary_pro)
area_RD <- st_area(walkroutes_di)

current.mode <- tmap_mode("plot")
map_3 <- tm_shape(background_bu, bbox = boundary_di_bu) +
  tm_polygons(col = "azure2", border.alpha = 0) + 
  tm_shape(background_ro) +
  tm_lines(scale = 0.5, col = "azure2") +
  tm_shape(walkroutes_di) +
  tm_polygons(scale = 4, col = "deepskyblue3", alpha = 0.5, border.alpha = 0) + 
  tm_shape(boundary_li) +
  tm_lines(scale = 4, col = "red") +
  tm_credits(expression("Service areas with line-based network 50m-buffer method is"~4~"km"^2), position=c("left", "bottom"))
  
map_3
```

```{r}
tmap_arrange(map_2, map_3, nrow = 1)
```

This image proposed a line-based network buffer method that defined areas near the center line of routes as accessible, which is more accurate, as it is closer to the actual environment available to pedestrians. As you can see in Map2 and Map3, the service areas determined by the route-based method were significantly less than those by Euclidean distance buffer method, which the ratio is `r as.numeric(round(round(area_RD/1000000)/round(area_ED/1000000), 2))`.











Owen, N.; Humpel, N.; Leslie, E.; Bauman, A.; Sallis, J.F. Understanding environmental influences on walking: Review and research agenda. Am. J. Prev. Med. 2004, 27, 67–76.

Rigolon, A.; Toker, Z.; Gasparian, N. Who has more walkable routes to parks? An environmental justice study of safe routes to parks in neighborhoods of Los Angeles. J. Urban Aff. 2018, 40, 576–591. 

Blanck, H.M.; Allen, D.; Bashir, Z.; Gordon, N.; Goodman, A.; Merriam, D.; Candace, R. Let’s go to the park today: The role of parks in obesity prevention and improving the public’s health. Child. Obes. 2012 , 8, 423–428.

Takano, T.; Nakamura, K.; Watanabe, M. Urban residential environments and senior citizens’ longevity in megacity areas: The importance of walkable green spaces. J. Epidemiol. Community Health 2002 , 56, 913–918.

Shanghai Urban Planning and Land Resources Administration Bureau. Planning Guidance of 15-Minute Community-Life Circle, 1st ed.; Shanghai Urban Planning and Land Resources Administration Bureau: Shanghai, China, 2016; pp. 21–46.
